# deobfuscation

**Note that the payload and loader were from different copies of bbystealer and use different endpoints**

- `*_original.js` contains the original source.
- `*_beautified.js` is the original code formatted, but otherwise unchanged.
- `*_deobfuscated.js` is fully deobfuscated code.

## Extracting obfuscated JavaScript

### loader

All the JavaScript used in the nexe executable is stored as plaintext within the exe itself.
This includes the loader, which is stored as a single line of obfuscated JavaScript.

The loader code can be found near the bottom of the executable, but before debugging dependencies if present.
It can be easily found in mose cases by searching for keywords found in the loader source code, such as "Discord".

To extract the loader, you copy the code as-is from the exe.
Take care to make sure no extra opening braces are included.

For example, the loader for the `OwOGame.exe` file can be found at line 889028.
It contains an opening brace at the end of the line, which should not be included when extracted.

### payload

The payload can be downloaded from the link found in the loader after deobfuscating it.
This link looks something like `https://indianboatparty[.]com/OOJfZ9s6pHbF/str`.

Alternatively, if the exe is run with a Discord installation present, the payload will be written to:

```js
process.env.LOCALAPPDATA + '\\*cord*\\app-*\\modules\\discord_desktop_core-*\\discord_desktop_core\\index.js'
```

## Formatting and initial deobfuscation

Both the loader and the payload can be formatted and partially deobfuscated using tools such as:

- [d4js](https://lelinhtinh.github.io/de4js/)
- [Online JavaScript Beautifier](https://beautifier.io/)

This makes the code more readable and can simplify some expressions.
For example:

```js
function onlyUnique(_0x25228c,_0x4dd03b,_0x115be5){const _0x4d4641={};_0x4d4641['gvSQz']=function(_0x4e9814,_0xe10a5a){return _0x4e9814===_0xe10a5a;};function _0x1c86f9(_0x8c86ab,_0x1044df,_0x6259b,_0x55e03d){return a0_0x5ce233(_0x8c86ab,_0x1044df-0x14f,_0x6259b-0x136,_0x55e03d- -0x648);}const _0x5f07df=_0x4d4641;return _0x5f07df[_0x1c86f9('hw71',0x40d,0x28c,0x1cd)](_0x115be5['index'+'Of'](_0x25228c),_0x4dd03b);}
```

becomes:

```js

function onlyUnique(_0x25228c, _0x4dd03b, _0x115be5) {
    const _0x4d4641 = {};
    _0x4d4641['gvSQz'] = function (_0x4e9814, _0xe10a5a) {
        return _0x4e9814 === _0xe10a5a;
    };

    function _0x1c86f9(_0x8c86ab, _0x1044df, _0x6259b, _0x55e03d) {
        return a0_0x5ce233(_0x8c86ab, _0x1044df - 0x14f, _0x6259b - 0x136, _0x55e03d - -0x648);
    }
    const _0x5f07df = _0x4d4641;
    return _0x5f07df[_0x1c86f9('hw71', 0x40d, 0x28c, 0x1cd)](_0x115be5['index' + 'Of'](_0x25228c), _0x4dd03b);
}
```

Furthermore, one obfuscation technique used splits strings into multiple parts.
d4js can be used to reverse this process, such that expressions such as `'crypt' + 'o'` becomes `'crypto'`.

From here, we can see the names and some information about global functions and variables.
The settings used to obfuscate this code did not allow these to be renamed.
This is an oversight as none of these are exported.
Enabling this would have made the code more difficult to analyse without changing its functionality.

Note that, once formatted, the code will no longer run.
If we try to run it at this stage, the V8 runtime will exceed its memory limit and crash.
This is because of self defending which is discussed in the next section.

## Defeating self defending

## Deobfuscating strings and members

## Deobfuscating function calls

## Fixing control flow
